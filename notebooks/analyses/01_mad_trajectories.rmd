---
title: "01_mad_trajectories.Rmd"
author: "Arlene L."
date: "2025-10-17"
output: html_document
---

### Description: In this script, we will 1) visualize raw trajectories, 2) compare maximnum absolute deviation (MAD) across conditions and 3) visualize differences in MAD across conditions.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Load in packages
library(here) 
library(tidyverse)
library(mousetrap) # for processing mouse trajectories
library(ggplot2)
library(ggbeeswarm)
library(cowplot) # for grouped plots
```

# Set up directories
```{r}
rootPath <- here::here()
dataPath <- file.path(rootPath, 'data/processed/trajectories')

# Get subject files 
sub_files <- list.files(dataPath, full.names = T, recursive = T)

# Establish plot colors 
uni_color <- c('#FFD93D'); comp_color <- c('#762E84')
```


# Obtain mouse data for selected participants
```{r}
# Prepare dataframe for everyone's data... 
mouse_enc_all <- data.frame()

for (s in sub_files){
  curr_mouse <- read.csv(s)
  mouse_enc_all<- rbind(mouse_enc_all, curr_mouse)}

# Reset the indices for the mouse_enc_all dataframe 
rownames(mouse_enc_all) <- NULL
```

```{r}
# For each subject... 
for (s in unique(mouse_enc_all$sub_label)){
  
  # Deal with current subject 
  sub_mouse_enc <- subset(mouse_enc_all, sub_label == s)
  
  # For each unique object, start naming objects 
  for (obj in unique(sub_mouse_enc$stimulus_name)){
    
    # Deal with the current object...
    curr_obj <- subset(sub_mouse_enc, stimulus_name == obj)
    
    # Sort by trial (+ assign pairmate labels)
    curr_obj <- curr_obj[order(curr_obj$Trial.Number),]
    mouse_enc_all[rownames(curr_obj)[1], 'pairmate_num'] <- 'first'
    
    if (nrow(curr_obj) == 2){mouse_enc_all[rownames(curr_obj)[2], 'pairmate_num'] <- 'second'}}}

# Then, create a column that combines the pairmate number and condition...
mouse_enc_all$cond_pairmate <- paste(mouse_enc_all$condition, mouse_enc_all$pairmate_num, sep='-')
```

```{r}
# Only take the paired information for now
enc_mouse_paired <- subset(mouse_enc_all, paired_status=='paired')

# Also, take the trials in which both pairmates were correct
enc_mouse_paired <- enc_mouse_paired %>% subset(both_enc_acc == 1)

# Factor our pairmate column into the order we want it to be
enc_mouse_paired$cond_pairmate <- factor(enc_mouse_paired$cond_pairmate, c('unique-first', 'unique-second', 'competing-first', 'competing-second'))

#### Exclude trials that do not have any mouse coordinates
enc_mouse_paired <- subset(enc_mouse_paired, x_pos != '')
```

# Convert data into mousetrap obj
```{r}
mt_obj <- mt_import_mousetrap(enc_mouse_paired, xpos_label='x_pos', ypos_label='y_pos', timestamps_label='time_trajectories', mt_id_label=NULL, split=' ', duplicates='remove_first', unordered='warn',reset_timestamps=T, digits=NULL, verbose=F)

# Obtain the mt measures
mt_analyzed <- mt_measures(mt_obj)

# Remove trajectories with no variance
mt_analyzed$data$pos_var <- apply(mt_analyzed$trajectories[,,"xpos"],1,var,na.rm=TRUE) + apply(mt_analyzed$trajectories[,,"ypos"],1,var,na.rm=TRUE)
table(mt_analyzed$data$pos_var==0) # view how many datapoints have a variance of 0
mt_analyzed <- mt_subset(mt_analyzed, pos_var>0)

# Time normalize the trajectories
mt_analyzed = mt_time_normalize(mt_analyzed)

# Merge the measures with the actual data 
mt_measures_data <- mt_analyzed$data %>% left_join(mt_analyzed$measures, by='mt_id')
```

# Visualize the data by viewing 50 sample trajectories from each condition
```{r}
# Define normalized x and y coords for decision phase components
x_coord_stim <- .5; y_coord_stim <- .8
x_left_choice <- .125; x_right_choice <- .875
y_choice <- .15
```

```{r, warning = FALSE}
# Just get sample trajectories for the unique condition
mt_analyzed_plot <- mt_analyzed
mt_uni <- subset(mt_measures_data, condition == 'unique' & pairmate_num == 'second')

# Shuffle the rows 
random_mad_uni <- mt_uni %>% slice_sample(n = 50) # get 50 shuffled rows

# Mark certain trajectories as included in our dataframe
for (r2 in random_mad_uni$mt_id){
  mt_analyzed_plot$data[r2,'plot_mark'] <- 'sample'}

# Build plot
rand_traj_uni <- mt_subset(mt_analyzed_plot, plot_mark == 'sample')
rand_traj_uni_plot <- mt_plot(rand_traj_uni, use="tn_trajectories", color='plot_mark') + ylab('Y Coordinate (Normalized)') + xlab('X Coordinate (Normalized)') + theme_minimal() + scale_colour_manual(values=uni_color) + xlim(0, 1) + ylim(0, .85) + theme(plot.title = element_text(family = "Avenir"), legend.position = "none") + ggtitle("Unique goal") +  annotate("label", x = x_left_choice, y = y_choice, label = "Choice\n1", size=4, label.padding=unit(1, "lines"), alpha=.7) + annotate("label", x = x_right_choice, y = y_choice, label = "Choice\n2", size=4, label.padding=unit(1, "lines"), alpha=.7) + annotate("label", x = x_coord_stim, y = y_coord_stim, label = "Item", size=4, label.padding=unit(1, "lines"), alpha=.7)

# Visualize plot below
rand_traj_uni_plot
```

```{r, warning = FALSE}
# Just get sample trajectories for the competing condition 
mt_analyzed_plot <- mt_analyzed
mt_comp <- subset(mt_measures_data, condition == 'competing' & pairmate_num == 'second')

# Shuffle the rows 
set.seed(789)
random_mad_comp <- mt_comp %>% slice_sample(n = 50) # get 50 shuffled rows

# Mark certain trajectories as included in our dataframe
for (r1 in random_mad_comp$mt_id){
  mt_analyzed_plot$data[r1,'plot_mark'] <- 'sample'}

# Build plot
rand_traj_comp <- mt_subset(mt_analyzed_plot, plot_mark == 'sample')
rand_traj_comp_plot <- mt_plot(rand_traj_comp, use="tn_trajectories", color='plot_mark') +  ylab('Y Coordinate (Normalized)') + xlab('X Coordinate (Normalized)') + theme_minimal() + scale_colour_manual('plot_mark', labels = c("25 Sample Trajectories\n(Competing)"), values=comp_color) + xlim(0, 1) + ylim(0, .85) + theme(plot.title = element_text(family = "Avenir"), legend.position = "none") + ggtitle("Competing goal") + annotate("label", x = x_left_choice, y = y_choice, label = "Choice\n1", size=4, label.padding=unit(1, "lines"), alpha=.7) + annotate("label", x = x_right_choice, y = y_choice, label = "Choice\n2", size=4, label.padding=unit(1, "lines"), alpha=.7) + annotate("label", x = x_coord_stim, y = y_coord_stim, label = "Item", size=4, label.padding=unit(1, "lines"), alpha=.7)

# Visualize plot below
rand_traj_comp_plot
```


```{r, warning = FALSE}
# Use cowplot to plot these next to each other
title_plot <- ggdraw() +
  draw_label("50 Sample Trajectories",
             size = 18,
             fontface = "bold", fontfamily = 'avenir',
             x = 0,
             hjust = -0.05)
gridded_plot <- cowplot::plot_grid(rand_traj_uni_plot, rand_traj_comp_plot, ncol = 2, labels = c("A", "B"))
gridded_plot_title <- cowplot::plot_grid(title_plot, gridded_plot, ncol = 1, rel_heights = c(0.5, 5, 10))
gridded_plot_title # visualize below

gridded_plot_final <- ggdraw(add_sub(gridded_plot_title, "In the sample trajectories above, we observe increased movement between the choice options\nin the Competing goal condition. This suggests a reversal in x-axis direction\ntoward the unselected choice prior to the final decision.", size=12, fontfamily='avenir', fontface='italic')) # add annotation

# Save visualization in png format
visualize_dir <- file.path(rootPath, 'visualizations')
if (!dir.exists(visualize_dir)) {dir.create(visualize_dir)} # create folder if it doesn't exist yet...
ggsave(file.path(visualize_dir, "01_sample_trajectories.png"), plot = gridded_plot_final, width = 30, height = 20, units = "cm", dpi = 300, bg = "white")
```

